<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>GitHub 文件管理</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,sans-serif}
  :root{--primary:#6366f1;--radius:12px}
  body{background:#f8fafc;padding-bottom:100px}
  .container{max-width:680px;margin:0 auto;padding:20px}
  .header{font-size:22px;font-weight:700;text-align:center;margin-bottom:16px}
  .tabs{display:flex;gap:10px;margin-bottom:18px}
  .tab{flex:1;padding:12px;border-radius:12px;border:none;background:#e2e8f0;cursor:pointer}
  .tab.active{background:var(--primary);color:#fff}
  .view{display:none}
  .view.show{display:block}

  .card{background:#fff;border-radius:var(--radius);padding:20px;box-shadow:0 1px 4px rgba(0,0,0,0.05)}
  .form-group{margin-bottom:14px}
  .form-group label{font-size:13px;margin-bottom:6px;display:block}
  input{width:100%;padding:8px 12px;border-radius:6px;border:1px solid #ddd}
  .btn{border-radius:8px;border:none;cursor:pointer;padding:8px 12px}
  .btn-primary{background:var(--primary);color:#fff}
  .btn-block{width:100%;padding:12px;font-size:14px}

  #fileInfo{margin:8px 0;font-size:13px;color:#444}

  .progress-wrap{
    margin:10px 0;
    height:6px;
    background:#e2e8f0;
    border-radius:3px;
    overflow:hidden;
    display:none;
  }
  .progress{
    height:100%;
    width:0%;
    background:var(--primary);
    transition:width 0.2s;
  }

  #uploadResult{
    margin-top:12px;
    padding:10px;
    background:#f0fdf4;
    border-radius:8px;
    font-size:13px;
    display:none;
  }
  .link-item{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:4px 0;
  }
  .link-item span{
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .link-item button{
    padding:4px 8px;
    font-size:12px;
    background:var(--primary);
    color:#fff;
    border:none;
    border-radius:6px;
    cursor:pointer;
  }

  .category{display:flex;gap:8px;margin-bottom:12px}
  .category button{padding:6px 12px;border-radius:6px;border:none;background:#e2e8f0;cursor:pointer}
  .category button.active{background:var(--primary);color:#fff}

  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
  .list{display:flex;flex-direction:column;gap:8px}

  .item{background:#fff;border-radius:var(--radius);overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.05);position:relative;}
  .list-item{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 12px;
    background:#fff;
    border-radius:8px;
    box-shadow:0 1px 3px rgba(0,0,0,0.05)
  }

  .thumb{width:100%;height:140px;object-fit:cover;background:#f1f5f9}
  .name{
    padding:10px;
    font-size:12px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    cursor:pointer;
    color:#333
  }
  .bar{display:flex;gap:6px;padding:0 8px 8px}
  .bar button{flex:1;padding:6px;font-size:12px}

  .pagination{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:6px;z-index:10}
  .pagination button,.pagination input{width:34px;height:34px;border-radius:8px;border:none;text-align:center;background:#fff}

  .mask{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:999}
  .mask.show{display:flex}
  .mask-body{background:#fff;width:90%;max-width:330px;border-radius:16px;padding:24px}
  .mask-actions{display:flex;gap:10px;margin-top:16px}
  .mask-actions button{flex:1;padding:10px;border-radius:8px;border:none}

  #toast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#222;color:#fff;padding:10px 16px;border-radius:8px;display:none;z-index:9999}
  .mini-btn{padding:4px 8px;font-size:12px}

  .img-refresh {
    position: absolute;
    top: 6px;
    right: 6px;
    width: 28px;
    height: 28px;
    background: rgba(255,255,255,0.9);
    border-radius: 50%;
    display: flex;
    align-items:center;
    justify-content:center;
    font-size:16px;
    cursor:pointer;
    z-index:10;
  }
</style>
</head>
<body>
<div id="toast">复制成功</div>

<div class="container">
  <div class="header">GitHub 文件管理</div>
  <div class="tabs">
    <button class="tab active" onclick="show('upload')">上传</button>
    <button class="tab" onclick="show('list')">文件列表</button>
  </div>

  <div class="view show" id="upload-view">
    <div class="card">
      <div class="form-group">
        <label>Token</label>
        <input type="text" id="token" value="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" readonly>
      </div>
      <div class="form-group">
        <label>选择文件</label>
        <input type="file" id="file" accept="*/*" multiple onchange="showSelected()">
      </div>
      <div id="fileInfo"></div>
      <div class="progress-wrap" id="progressWrap">
        <div class="progress" id="progress"></div>
      </div>
      <button class="btn btn-primary btn-block" onclick="upload()">开始上传</button>
      <div id="uploadResult">
        <div id="linkList"></div>
      </div>
    </div>
  </div>

  <div class="view" id="list-view">
    <div class="card">
      <div class="category">
        <button class="active" onclick="setCat('all')">全部</button>
        <button onclick="setCat('image')">图片</button>
        <button onclick="setCat('other')">其它</button>
      </div>
      <div id="container"></div>
    </div>
  </div>
</div>

<div class="pagination">
  <button onclick="prev()">&lt;</button>
  <input type="number" id="pageInput" onchange="goPage()">
  <span>/</span>
  <span id="totalPage">1</span>
  <button onclick="next()">&gt;</button>
</div>

<div class="mask" id="renameMask">
  <div class="mask-body">
    <h3 style="margin-bottom:12px">重命名</h3>
    <input type="text" id="newName" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-bottom:16px">
    <div class="mask-actions">
      <button onclick="closeMask()">取消</button>
      <button class="btn-primary" onclick="doRename()">确定</button>
    </div>
  </div>
</div>

<script>
const cfg = {
  owner: "linshanghui",
  repo: "img",
  token: "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",
  pageSize: 6
};

let allFiles = [];
let page = 1;
let totalPage = 1;
let cat = "all";
let renamePath = "";

function $(id) { return document.getElementById(id); }

window.onload = function() {
  $("token").value = cfg.token;
};

function toast(msg) {
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  setTimeout(() => t.style.display = "none", 1400);
}

async function copyText(text) {
  try {
    await navigator.clipboard.writeText(text);
    toast("复制成功");
  } catch (e) {
    const input = document.createElement("input");
    input.value = text;
    document.body.appendChild(input);
    input.select();
    document.execCommand("copy");
    document.body.removeChild(input);
    toast("复制成功");
  }
}

function copyLink(path) {
  const url = `https://raw.githubusercontent.com/${cfg.owner}/${cfg.repo}/main/${path}`;
  copyText(url);
}

function refreshImg(img, path) {
  img.src = `https://raw.githubusercontent.com/${cfg.owner}/${cfg.repo}/main/${path}?t=${Date.now()}`;
}

function show(view) {
  document.querySelectorAll(".view").forEach(el => el.classList.remove("show"));
  document.querySelectorAll(".tab").forEach(el => el.classList.remove("active"));
  $(view + "-view").classList.add("show");
  event.currentTarget.classList.add("active");
  if (view === "list") initList();
}

async function initList() {
  try {
    const res = await fetch(`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents`);
    allFiles = await res.json() || [];
    page = 1;
    render();
  } catch (e) {
    toast("加载失败");
  }
}

function setCat(c) {
  cat = c;
  document.querySelectorAll(".category button").forEach(b => b.classList.remove("active"));
  const btns = document.querySelectorAll(".category button");
  if(c==='all') btns[0].classList.add("active");
  else if(c==='image') btns[1].classList.add("active");
  else btns[2].classList.add("active");
  render();
}

function showSelected() {
  const f = $("file").files;
  $("fileInfo").textContent = f.length ? `已选中 ${f.length} 个文件` : "";
  $("uploadResult").style.display = "none";
}

function ext(name) {
  const parts = name.split(".");
  return parts.length > 1 ? parts.pop().toUpperCase() : "";
}

function isImg(name) {
  const e = ext(name);
  return ["JPG","JPEG","PNG","GIF","BMP","WEBP","SVG"].includes(e);
}

// 安全转义
function esc(s) {
  return s.replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

function render() {
  let filtered = [];
  if (cat === "all") filtered = [...allFiles];
  else if (cat === "image") filtered = allFiles.filter(f => isImg(f.name));
  else filtered = allFiles.filter(f => !isImg(f.name));

  totalPage = Math.ceil(filtered.length / cfg.pageSize);
  const start = (page - 1) * cfg.pageSize;
  const pageItems = filtered.slice(start, start + cfg.pageSize);

  $("pageInput").value = page;
  $("totalPage").textContent = totalPage;
  const el = $("container");

  if (cat === "other") {
    el.className = "list";
    el.innerHTML = pageItems.map(f => {
      const path = esc(f.path);
      const name = esc(f.name);
      return `
      <div class="list-item">
        <span onclick="copyLink('${path}')">${name}</span>
        <div style="display:flex;gap:6px">
          <button class="btn mini-btn" onclick="rename('${path}')">重命名</button>
          <button class="btn btn-primary mini-btn" onclick="del('${path}')">删除</button>
        </div>
      </div>`;
    }).join("");
    return;
  }

  el.className = "grid";
  el.innerHTML = pageItems.map(f => {
    const path = esc(f.path);
    const name = esc(f.name);
    if (isImg(f.name)) {
      const url = `https://raw.githubusercontent.com/${cfg.owner}/${cfg.repo}/main/${esc(f.path)}`;
      return `
      <div class="item">
        <img src="${url}" class="thumb">
        <div class="img-refresh" onclick="refreshImg(this.previousElementSibling,'${path}')">↻</div>
        <div class="name" onclick="copyLink('${path}')">${name}</div>
        <div class="bar">
          <button class="btn" onclick="rename('${path}')">重命名</button>
          <button class="btn btn-primary" onclick="del('${path}')">删除</button>
        </div>
      </div>`;
    } else {
      return `
      <div class="item">
        <div class="thumb" style="display:flex;align-items:center;justify-content:center">FILE</div>
        <div class="name" onclick="copyLink('${path}')">${name}</div>
        <div class="bar">
          <button class="btn" onclick="rename('${path}')">重命名</button>
          <button class="btn btn-primary" onclick="del('${path}')">删除</button>
        </div>
      </div>`;
    }
  }).join("");
}

function prev() { if (page > 1) { page--; render(); } }
function next() { if (page < totalPage) { page++; render(); } }
function goPage() {
  const v = parseInt($("pageInput").value);
  if (v >= 1 && v <= totalPage) { page = v; render(); }
}

async function upload() {
  const files = $("file").files;
  if (!files.length) return alert("请选择文件");

  const wrap = $("progressWrap");
  const bar = $("progress");
  const result = $("uploadResult");
  const list = $("linkList");

  wrap.style.display = "block";
  bar.style.width = "0%";
  result.style.display = "none";
  list.innerHTML = "";

  const total = files.length;
  let successLinks = [];

  for (let i = 0; i < total; i++) {
    const file = files[i];
    await new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const content = e.target.result.split(",")[1];
          await fetch(`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${file.name}`, {
            method: "PUT",
            headers: { Authorization: `token ${cfg.token}` },
            body: JSON.stringify({ message: "upload", content })
          });
          const url = `https://raw.githubusercontent.com/${cfg.owner}/${cfg.repo}/main/${file.name}`;
          successLinks.push({ name: file.name, url });
        } catch (err) {
          toast(`${file.name} 上传失败`);
        }
        bar.style.width = (((i + 1) / total) * 100).toFixed(0) + "%";
        resolve();
      };
      reader.readAsDataURL(file);
    });
  }

  if (successLinks.length > 0) {
    list.innerHTML = successLinks.map(item => `
      <div class="link-item">
        <span>${esc(item.name)}</span>
        <button onclick="copyText('${esc(item.url)}')">复制</button>
      </div>
    `).join("");
    result.style.display = "block";
    toast("全部上传完成");
  }

  wrap.style.display = "none";
  $("file").value = "";
  $("fileInfo").textContent = "";
  initList();
}

// 修复删除白屏
async function del(path) {
  if (!confirm("确定删除？")) return;
  try {
    const res = await fetch(`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${path}`);
    if (!res.ok) throw new Error("获取文件失败");
    const data = await res.json();
    const delRes = await fetch(`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${path}`, {
      method: "DELETE",
      headers: { Authorization: `token ${cfg.token}` },
      body: JSON.stringify({ sha: data.sha, message: "del" })
    });
    toast(delRes.ok ? "删除成功" : "删除失败");
  } catch (e) {
    console.error(e);
    toast("删除失败");
  } finally {
    initList();
  }
}

async function doRename() {
  const newName = $("newName").value.trim();
  if (!newName) return alert("请输入名称");
  try {
    const old = renamePath;
    const res = await fetch(`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${old}`);
    const data = await res.json();

    await fetch(`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${newName}`, {
      method: "PUT",
      headers: { Authorization: `token ${cfg.token}` },
      body: JSON.stringify({ message: "rename", content: data.content })
    });

    await fetch(`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${old}`, {
      method: "DELETE",
      headers: { Authorization: `token ${cfg.token}` },
      body: JSON.stringify({ sha: data.sha, message: "del old" })
    });

    toast("重命名成功");
    closeMask();
  } catch (e) {
    toast("失败");
  }
  initList();
}

function rename(path) {
  renamePath = path;
  $("newName").value = path.split("/").pop();
  $("renameMask").classList.add("show");
}
function closeMask() {
  $("renameMask").classList.remove("show");
}
</script>
</body>
</html>
